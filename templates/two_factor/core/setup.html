{% extends "admin/base_site.html" %}
{% load i18n qr_tags %}

{% block title %}{% trans "Configurar verificación en dos pasos" %} | {{ block.super }}{% endblock %}

{% block extrastyle %}{{ block.super }}
<style>
  .auth-wrap { width: 100%; display: flex; justify-content: center; padding: 24px 12px; box-sizing: border-box; }
  .auth-card { width: 100%; max-width: 720px; background: var(--body-bg); border: 1px solid var(--hairline-color);
               border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
  .auth-card .header { padding: 16px 20px; border-bottom: 1px solid var(--hairline-color);
                       background: var(--darkened-bg); border-top-left-radius: 8px; border-top-right-radius: 8px; }
  .auth-card .content { padding: 20px; }
  .step-badge { display: inline-block; padding: 4px 10px; border-radius: 999px; background: var(--primary); color: #fff; font-size: 12px; margin-left: 8px; }
  .qr { display:flex; gap:20px; align-items:flex-start; justify-content:center; margin: 12px 0; }
  .qr img { display:block; max-width: 260px; height:auto; border-radius:6px; border:1px solid var(--hairline-color); background:#fff; }
  .field-row { margin: 14px 0; }
  .field-row label { display:block; font-weight:600; margin-bottom:6px; }
  .field-row input, .field-row select { width:100%; padding:8px 10px; border:1px solid var(--border-color); border-radius:6px; background: var(--body-bg); color: var(--body-fg); }
  .btn { background: var(--primary); color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn-secondary { background: var(--border-color); color: var(--body-fg); }
  .help { color: var(--body-quiet-color); font-size: 12px; margin-top: 4px; }
  .errorlist { color: var(--error-fg); margin: 8px 0; }
</style>
{% endblock %}

{% block content %}
<div id="content" class="colM">
  <div class="auth-wrap">
    <div class="auth-card">
      <div class="header">
        <h1 class="app-title">{% trans "Configurar verificación en dos pasos" %}</h1>
        {% if wizard.steps.prev %}
          <span class="step-badge">{% trans "Paso 2 de 2" %}</span>
        {% else %}
          <span class="step-badge">{% trans "Paso 1 de 2" %}</span>
        {% endif %}
      </div>

      <div class="content">
        {% if messages %}
          <ul class="messagelist">
            {% for message in messages %}
              <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}

        <form method="post" action="" novalidate>
          {% csrf_token %}
          {{ wizard.management_form }}

          <input type="hidden" name="next" value="{{ request.GET.next|default:'/admin/' }}">

          {% if wizard.form.non_field_errors %}
            <div class="errorlist">{{ wizard.form.non_field_errors }}</div>
          {% endif %}

          {% if otpauth_url or QR_URL or qr_code or qr_code_url or secret_key %}
            <div class="qr">
              <div>
                {% if otpauth_url %}
                  <img alt="{% trans 'Código QR para TOTP' %}" src="{% qr_data_uri otpauth_url 6 2 %}">
                {% elif QR_URL %}
                  <img alt="{% trans 'Código QR para TOTP' %}" src="{{ QR_URL|safe }}">
                {% elif qr_code %}
                  <img alt="{% trans 'Código QR para TOTP' %}" src="{{ qr_code|safe }}">
                {% elif qr_code_url %}
                  <img alt="{% trans 'Código QR para TOTP' %}" src="{{ qr_code_url|safe }}">
                {% endif %}
              </div>
              <div>
                {% if secret_key %}
                  <p><strong>{% trans "Clave manual:" %}</strong> <code>{{ secret_key }}</code></p>
                  <div class="help">{% trans "Guárdala en un lugar seguro." %}</div>
                {% endif %}
              </div>
            </div>
          {% endif %}

          {% for field in wizard.form.visible_fields %}
            <div class="field-row">
              <label for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %} *{% endif %}</label>

              {% if field.name == "token" or field.name == "otp_token" or field.name == "otp" %}
                <input
                  type="text"
                  id="{{ field.id_for_label }}"
                  name="{{ field.html_name }}"
                  value="{{ field.value|default_if_none:'' }}"
                  inputmode="numeric" pattern="[0-9]*" maxlength="6"
                  autocomplete="one-time-code" dir="ltr"
                  class="vTextField"
                  style="width:100%;padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;background: var(--body-bg);color: var(--body-fg);"
                  {% if field.field.required %}required{% endif %}
                />
                {# ---- NUEVO: aviso de intentos restantes ---- #}
                {% if wizard.form.attempts_left is not None %}
                  <div class="help">
                    {% if wizard.form.attempts_left > 0 %}
                      Te quedan {{ wizard.form.attempts_left }} intento{% if wizard.form.attempts_left != 1 %}s{% endif %} antes del bloqueo de {{ wizard.form.lock_hours }} h.
                    {% else %}
                      Has alcanzado el límite de intentos. Vuelve a intentarlo más tarde.
                    {% endif %}
                  </div>
                {% endif %}
                {# ------------------------------------------- #}
              {% else %}
                {{ field }}
              {% endif %}

              {% if field.help_text %}
                <div class="help">{{ field.help_text|safe }}</div>
              {% endif %}
              {% for error in field.errors %}
                <div class="errorlist">{{ error }}</div>
              {% endfor %}
            </div>
          {% endfor %}

          <div style="display:flex; gap:8px; margin-top:12px; justify-content:center;">
            <button type="submit" class="btn">
              {% if wizard.steps.current == wizard.steps.last %}
                {% trans "Finalizar configuración" %}
              {% else %}
                {% trans "Continuar" %}
              {% endif %}
            </button>
            {% if wizard.steps.prev %}
              <button name="wizard_goto_step" value="{{ wizard.steps.prev }}" class="btn btn-secondary" type="submit">
                {% trans "Volver" %}
              </button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
