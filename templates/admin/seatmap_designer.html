{% extends "admin/base_site.html" %}
{% load static %}
{% block title %}{{ title }} | {{ site_title }}{% endblock %}

{% block extrahead %}
<link rel="icon" href="data:,">
<style>
  /* ====== √ÅREA AISLADA PARA EVITAR CHOQUES CON JAZZMIN ====== */
  .seatsio-designer { --b:#e5e7eb; --bg:#fafafa; --btn:#fff; --green:#16a34a; --pad:12px; --gap:8px; }
  .seatsio-designer, .seatsio-designer * { box-sizing: border-box; }

  .seatsio-designer .seat-toolbar{
    display:flex; gap:.5rem; align-items:center; margin:8px 0 12px; flex-wrap:wrap;
  }
  .seatsio-designer .seat-toolbar button,
  .seatsio-designer .seat-toolbar input,
  .seatsio-designer .seat-toolbar label,
  .seatsio-designer .seat-toolbar select{
    font: inherit; line-height: 1.1;
  }
  .seatsio-designer .seat-toolbar button{
    appearance:none; -webkit-appearance:none; background:var(--btn);
    padding:6px 10px; border:1px solid var(--b); border-radius:8px; cursor:pointer;
    box-shadow:none !important; color:inherit !important;
  }
  .seatsio-designer .seat-toolbar button.active{ background:#eef2ff; border-color:#6366f1; }
  .seatsio-designer .seat-toolbar input[type="color"]{ width:36px; height:36px; padding:0; border:none; background:transparent }
  .seatsio-designer .seat-toolbar .field{ display:flex; align-items:center; gap:6px; }
  .seatsio-designer .seat-toolbar select{
    appearance:none; -webkit-appearance:none; background:#fff; border:1px solid var(--b); border-radius:8px; padding:6px 26px 6px 10px;
    background-image: linear-gradient(45deg, transparent 50%, #6b7280 50%), linear-gradient(135deg, #6b7280 50%, transparent 50%), linear-gradient(to right, #fff, #fff);
    background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 10px) calc(50% - 3px), 100% 0;
    background-size: 8px 8px, 8px 8px, 2.5em 100%; background-repeat: no-repeat;
  }

  .seatsio-designer #designer-wrapper{
    width:100%;
    height: var(--designer-height, 70vh);
    min-height: 420px;
    display:flex; gap:0;
    border:1px solid var(--b); border-radius:10px; overflow:hidden; background:var(--bg);
  }
  .seatsio-designer #stage-container{
    flex:1; position:relative; height:100%; background:#fff;
    background-image:linear-gradient(to right,#e2e8f0 1px,transparent 1px),
                     linear-gradient(to bottom,#e2e8f0 1px,transparent 1px);
    background-size:40px 40px;
  }
  .seatsio-designer #cvs{ width:100%; height:100%; background:transparent; display:block; }
  .seatsio-designer #info-panel{
    width:340px; max-width: 40vw;
    border-left:1px solid var(--b); background:#fff; padding:12px; overflow:auto; font-size:.9rem
  }
  .seatsio-designer #info-panel h3{ margin:10px 0 6px; font-size:.95rem }
  .seatsio-designer .pill{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--b); border-radius:999px; background:#fff; margin:2px 4px 6px 0 }
  .seatsio-designer .pill .dot{ width:10px; height:10px; border-radius:50%; border:1px solid #cbd5e1 }
  .seatsio-designer .seat-row{ display:flex; align-items:center; margin-bottom:4px; font-family:monospace; cursor:pointer }
  .seatsio-designer .seat-row span,.seatsio-designer .seat-row input,.seatsio-designer .seat-row select{ flex:1; text-align:center; padding:2px }
  .seatsio-designer .seat-row input{ width:90%; border:1px solid var(--b); border-radius:4px; padding:2px }
  .seatsio-designer .seat-row select{ width:100%; border:1px solid var(--b); border-radius:4px; padding:2px; background:#fff }
  .seatsio-designer .legend{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px }
  .seatsio-designer .legend .item{ display:flex; gap:6px; align-items:center; background:#fff; border:1px solid var(--b); border-radius:8px; padding:4px 8px }
  .seatsio-designer .legend .swatch{ width:14px; height:14px; border-radius:50%; border:1px solid #cbd5e1 }
  .seatsio-designer .hint{ color:#6b7280; font-size:.9rem; margin-top:6px }
  .seatsio-designer .pt-hint{ position:absolute; pointer-events:none; background:#111827; color:#fff; font-size:12px; padding:2px 6px; border-radius:4px; transform:translate(-50%,-140%) }
</style>
<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}
<div id="designer-root" class="seatsio-designer">
  <div class="seat-toolbar" id="seat-toolbar">
    <button id="tool-pan" class="active">üñêÔ∏è Pan</button>
    <button id="tool-select">‚ú• Selecci√≥n</button>
    <button id="tool-seat">‚≠ï Asiento</button>
    <button id="tool-row">„Ä∞Ô∏è Fila</button>
    <button id="tool-section">‚¨ö Secci√≥n</button>

    <span class="field">Secci√≥n actual
      <select id="current-section"></select>
    </span>

    <span class="field">Radio <input id="seat-radius" type="number" min="4" max="30" step="1" value="10" style="width:64px"></span>
    <span class="field"># asientos <input id="row-count" type="number" min="1" max="100" step="1" value="10" style="width:64px"></span>
    <span class="field">Espacio X <input id="gap-x" type="number" min="4" max="100" step="1" value="24" style="width:64px"></span>
    <span class="field">Espacio Y <input id="gap-y" type="number" min="4" max="100" step="1" value="26" style="width:64px"></span>
    <span class="field">Color <input id="tool-color" type="color" value="#63b46b"></span>

    <button id="btn-zoom-in" title="Zoom in">Ôºã</button>
    <button id="btn-zoom-out" title="Zoom out">Ôºç</button>
    <button id="btn-fit" title="Ajustar">‚ÜîÔ∏é Fit</button>
    <button id="btn-undo" title="Deshacer">‚Ü∂</button>
    <button id="btn-redo" title="Rehacer">‚Ü∑</button>
    <button id="btn-delete" title="Eliminar selecci√≥n">üóëÔ∏è</button>

    <button id="btn-save" style="margin-left:auto;background:var(--green);color:#fff;border-color:var(--green)">üíæ Guardar</button>
  </div>

  <div id="designer-wrapper">
    <div id="stage-container">
      <canvas id="cvs"></canvas>
      <div id="pt-hint" class="pt-hint" style="display:none;">Enter para cerrar</div>
    </div>
    <div id="info-panel"></div>
  </div>

  <p class="hint">
    <b>Secci√≥n</b>: clics para v√©rtices, <b>Enter</b> cierra, <b>Esc</b> cancela.  
    <b>Editar</b> secci√≥n: doble-click ‚Üí v√©rtices azules (mover/borrar) y blancos (a√±adir).  
    Renombres hechos en el admin se reflejan al cargar aqu√≠.
  </p>

  <div class="legend" id="legend"></div>
  <form id="csrf-form">{% csrf_token %}</form>
</div>

<script>
/* ===== Responsive dentro de Jazzmin ===== */
(function(){
  const root=document.getElementById('designer-root');
  const wrap=document.getElementById('designer-wrapper');

  function layout(){
    const rect=root.getBoundingClientRect();
    const vh  = window.innerHeight || document.documentElement.clientHeight;
    const H   = Math.max(420, vh - rect.top - 24);
    root.style.setProperty('--designer-height', H+'px');
    wrap.style.height = H+'px';
    if(window.fabricCanvasReady) window.fabricCanvasReady();
  }
  new ResizeObserver(layout).observe(root);
  window.addEventListener('resize', layout);
  window.addEventListener('load', layout);
  document.addEventListener('DOMContentLoaded', layout);
  document.body.addEventListener('transitionend', (e)=>{
    if(e.propertyName==='margin-left' || e.propertyName==='width') layout();
  });
  window.__seatsio_layout = layout;
})();
</script>

<script>
/* ======== L√ìGICA DEL DISE√ëADOR ======== */
const LOAD_URL="{{ load_url }}", SAVE_URL="{{ save_url }}";
const CSRF_TOKEN=document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;
const Toast=Swal.mixin({toast:true,position:'top-end',showConfirmButton:false,timer:1600,timerProgressBar:true});

/* Estado */
let mode="pan", seatRadius=10, gapX=24, gapY=26, rowCount=10, activeColor="#63b46b";
let legend=[], seatIdCounter=1, clipboard=null;
let drawingSection=false, sectionPoints=[], tempPolyline=null, tempPreview=null, tempMarkers=[];
let sectionEditing=null, editHandles=[], midHandles=[], editBackup=[], selectedHandle=null;
let hoveringObject=false;

const canvas=new fabric.Canvas('cvs',{selection:true,preserveObjectStacking:true,fireRightClick:false,stopContextMenu:true});

/* Redimensiona canvas */
function resizeCanvas(){
  const el=document.getElementById('stage-container');
  canvas.setWidth(el.clientWidth);
  canvas.setHeight(el.clientHeight);
  canvas.requestRenderAll();
}
window.fabricCanvasReady = resizeCanvas;
window.addEventListener('resize', resizeCanvas);
setTimeout(()=>{ if(window.__seatsio_layout) window.__seatsio_layout(); }, 50);

/* ===== Toolbar / modo ===== */
function refreshCursor(){
  if(mode==='pan'){ canvas.defaultCursor = 'grab'; return; }
  if(mode==='row' || mode==='seat'){ canvas.defaultCursor = hoveringObject ? 'move' : 'crosshair'; return; }
  if(mode==='section'){ canvas.defaultCursor = 'crosshair'; return; }
  canvas.defaultCursor = 'default';
}
function setMode(m){
  document.querySelectorAll('.seatsio-designer .seat-toolbar button').forEach(b=>b.classList.remove('active'));
  const map={pan:'tool-pan',select:'tool-select',seat:'tool-seat',row:'tool-row',section:'tool-section'};
  document.getElementById(map[m]).classList.add('active');
  mode=m; canvas.isDrawingMode=false;
  // Permitimos seleccionar objetos tambi√©n en modos de creaci√≥n (evita doble acci√≥n)
  canvas.selection=(m!=='pan'); 
  if(m!=='section') cancelSectionDrawing();
  refreshCursor();
}
document.getElementById('tool-pan').onclick=()=>setMode('pan');
document.getElementById('tool-select').onclick=()=>setMode('select');
document.getElementById('tool-seat').onclick=()=>setMode('seat');
document.getElementById('tool-row').onclick=()=>setMode('row');
document.getElementById('tool-section').onclick=()=>setMode('section');

document.getElementById('seat-radius').oninput=e=>seatRadius=+e.target.value||10;
document.getElementById('gap-x').oninput=e=>gapX=+e.target.value||24;
document.getElementById('gap-y').oninput=e=>gapY=+e.target.value||26;
document.getElementById('row-count').oninput=e=>rowCount=+e.target.value||10;

const colorInput=document.getElementById('tool-color');
colorInput.oninput=e=>{
  const c=e.target.value, sel=canvas.getActiveObjects().filter(o=>o.kind==='seat');
  if(sel.length){
    sel.forEach(s=>{ s.set({fill:c}); s.category=guessCategoryFromColor(c)||s.category; s.seat_type=guessSeatTypeFromCategory(s.category)||'standard'; });
    canvas.requestRenderAll(); pushHistory(); updateInfoPanel();
  } else activeColor=c;
};
function updateColorInput(){ const seats=canvas.getActiveObjects().filter(o=>o.kind==='seat'); colorInput.value=seats.length===1?seats[0].fill:activeColor; }
canvas.on('selection:created',updateColorInput);
canvas.on('selection:updated',updateColorInput);
canvas.on('selection:cleared',updateColorInput);

/* ===== Zoom/Pan + hover ===== */
canvas.on('mouse:wheel',opt=>{ let z=canvas.getZoom(); z*=0.999**opt.e.deltaY; z=Math.max(.2,Math.min(4,z)); canvas.zoomToPoint({x:opt.e.offsetX,y:opt.e.offsetY},z); opt.e.preventDefault(); opt.e.stopPropagation(); });
document.getElementById('btn-zoom-in').onclick=()=>canvas.setZoom(canvas.getZoom()*1.15);
document.getElementById('btn-zoom-out').onclick=()=>canvas.setZoom(canvas.getZoom()/1.15);

canvas.on('mouse:over', e => { if(e.target){ hoveringObject=true; refreshCursor(); }});
canvas.on('mouse:out',  e => { hoveringObject=false; refreshCursor(); });

let isPanning=false;
canvas.on('mouse:down',opt=>{
  // Pan solo en modo pan (o barra espaciadora)
  if(mode==='pan'||opt.e.code==='Space'||opt.e.key===' '){ isPanning=true; canvas.defaultCursor='grabbing'; return; }

  // >>> Antidoble-acci√≥n: si clic sobre un objeto y estamos en modo de creaci√≥n/dibujo, NO crear nada.
  if(opt.target && (mode==='row' || mode==='seat' || mode==='section')){
    // dejamos que Fabric seleccione/arrastre/edite el objeto
    return;
  }

  if(mode==='seat') placeSeat(opt);
  if(mode==='row')  placeRow(opt);
  if(mode==='section') addSectionPoint(opt);
});
canvas.on('mouse:move',opt=>{ if(drawingSection) drawSectionPreview(opt); if(!isPanning) return; const v=canvas.viewportTransform; v[4]+=opt.e.movementX; v[5]+=opt.e.movementY; canvas.requestRenderAll(); });
canvas.on('mouse:up',()=>{ isPanning=false; refreshCursor(); });

/* ===== Helpers ===== */
function guessSeatTypeFromCategory(c){ c=(c||'').toLowerCase(); if(c==='vip')return'vip'; if(c==='accessible')return'accessible'; return'standard'; }
function guessCategoryFromColor(color){ return (legend||[]).find(x=>(x.color||'').toLowerCase()===String(color).toLowerCase())?.key||null; }
function guessColorByKey(k){ return (legend||[]).find(x=>x.key===k)?.color||'#63b46b'; }
function norm(s){ return String(s||'').trim().toLowerCase(); }

function pointInsideSectionAbs(pt, poly){
  const m=poly.calcTransformMatrix();
  const pts=poly.points.map(p=>{ const tp=fabric.util.transformPoint(new fabric.Point(p.x-poly.pathOffset.x,p.y-poly.pathOffset.y), m); return {x:tp.x,y:tp.y}; });
  let inside=false;
  for(let i=0,j=pts.length-1;i<pts.length;j=i++){
    const xi=pts[i].x, yi=pts[i].y, xj=pts[j].x, yj=pts[j].y;
    const inter=((yi>pt.y)!==(yj>pt.y)) && (pt.x < (xj-xi)*(pt.y-yi)/(yj-yi+1e-9)+xi);
    if(inter) inside=!inside;
  }
  return inside;
}
function currentSectionObj(){ const key=document.getElementById('current-section').value||''; if(!key) return null; return canvas.getObjects().find(o=>o.kind==='section'&&o.section_key===key); }
function ensureSectionSelectedFor(p){ const s=currentSectionObj(); if(!s){ Toast.fire({icon:'info',title:'Crea/selecciona una secci√≥n primero'}); return null; } if(!pointInsideSectionAbs(p,s)){ Toast.fire({icon:'info',title:`Haz clic dentro de ‚Äú${s.section_name}‚Äù`}); return null; } return s; }
function refreshSectionSelector(){
  const sel=document.getElementById('current-section'), prev=sel.value; sel.innerHTML='';
  const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='‚Äî seleccionar ‚Äî'; sel.appendChild(opt0);
  canvas.getObjects().filter(o=>o.kind==='section').sort((a,b)=>(a.section_order||0)-(b.section_order||0))
    .forEach(sec=>{ const op=document.createElement('option'); op.value=sec.section_key; op.textContent=sec.section_name; sel.appendChild(op); });
  if([...[...sel.options]].some(o=>o.value===prev)) sel.value=prev;
}

/* ===== Seats/Rows ===== */
function seatCircle(x,y,sec,opts={}){
  const c=new fabric.Circle({left:x-seatRadius,top:y-seatRadius,radius:seatRadius,fill:opts.color||activeColor,stroke:'#334155',strokeWidth:.6,originX:'left',originY:'top'});
  c.kind='seat'; c.number=opts.number||''; c.category=opts.category||guessCategoryFromColor(c.fill); c.seat_type=opts.seat_type||guessSeatTypeFromCategory(c.category);
  c.id=opts.id||('seat-'+seatIdCounter++); c.row_name=opts.row_name||''; c.row_index=opts.row_index||null;
  if(sec){ c.section_key=sec.section_key; c.section_name=sec.section_name; c.section_db_id=sec.section_db_id||null; }
  c.on('mousedblclick',async()=>{ await editSeatDialog(c); });
  return c;
}
function nextLetter(n){const A='A'.charCodeAt(0);let s='';n++;while(n>0){n--;s=String.fromCharCode(A+(n%26))+s;n=Math.floor(n/26);}return s;}
function nextRowNameForSection(sec){
  const seats=canvas.getObjects().filter(o=>o.kind==='seat'&&o.section_key===sec.section_key&&o.row_name);
  const set=new Set(seats.map(s=>s.row_name)); let i=0; while(set.has(nextLetter(i))) i++; return nextLetter(i);
}
async function placeRow(opt){
  const p=canvas.getPointer(opt.e); const sec=ensureSectionSelectedFor(p); if(!sec) return;
  const defaultName=nextRowNameForSection(sec);
  const {value:form}=await Swal.fire({
    title:'Nueva fila',
    html:`<div style="text-align:left">
      <label>Nombre</label><input id="r-name" class="swal2-input" value="${defaultName}">
      <label># Asientos</label><input id="r-count" class="swal2-input" type="number" value="${rowCount}" min="1" max="200">
      <label>Separaci√≥n X</label><input id="r-gapx" class="swal2-input" type="number" value="${gapX}" min="1" max="200">
      <label>Num. inicial</label><input id="r-start" class="swal2-input" type="number" value="1" min="1" max="9999">
    </div>`,
    focusConfirm:false, showCancelButton:true,
    preConfirm:()=>{
      const name=document.getElementById('r-name').value.trim();
      const count=parseInt(document.getElementById('r-count').value||rowCount,10);
      const gx=parseFloat(document.getElementById('r-gapx').value||gapX);
      const start=parseInt(document.getElementById('r-start').value||1,10);
      if(!name) { Swal.showValidationMessage('Nombre requerido'); return false; }
      if(!count || count<1) { Swal.showValidationMessage('Cantidad inv√°lida'); return false; }
      return {name,count,gx,start};
    }
  });
  if(!form) return;
  const rowIdx = computeExistingRowCount(sec) + 1;
  for(let i=0;i<form.count;i++){
    const cx=p.x + i*form.gx, cy=p.y;
    const number=String(form.start+i);
    const seat=seatCircle(cx,cy,sec,{number, row_name:form.name, row_index:rowIdx});
    canvas.add(seat);
  }
  pushHistory(); updateInfoPanel();
}
function computeExistingRowCount(sec){
  const names=new Set(canvas.getObjects().filter(o=>o.kind==='seat'&&o.section_key===sec.section_key&&o.row_name).map(s=>s.row_name));
  return names.size;
}
function placeSeat(opt){ const p=canvas.getPointer(opt.e); const s=ensureSectionSelectedFor(p); if(!s) return; canvas.add(seatCircle(p.x,p.y,s,{})); pushHistory(); updateInfoPanel(); }

/* ===== Secci√≥n: dibujo/edici√≥n ===== */
function startSectionDrawing(){ drawingSection=true; sectionPoints=[]; clearTempDraw(); }
function clearTempDraw(){ if(tempPolyline){ canvas.remove(tempPolyline); tempPolyline=null; } if(tempPreview){ canvas.remove(tempPreview); tempPreview=null; } if(tempMarkers.length){ tempMarkers.forEach(m=>canvas.remove(m)); tempMarkers=[]; } document.getElementById('pt-hint').style.display='none'; }
function cancelSectionDrawing(){ drawingSection=false; sectionPoints=[]; clearTempDraw(); canvas.requestRenderAll(); }
function addSectionPoint(opt){ if(!drawingSection) startSectionDrawing(); const p=canvas.getPointer(opt.e); sectionPoints.push({x:p.x,y:p.y}); drawSectionTemp(); }
function drawSectionTemp(){
  if(tempPolyline){ canvas.remove(tempPolyline); tempPolyline=null; }
  tempMarkers.forEach(m=>canvas.remove(m)); tempMarkers=[];
  if(sectionPoints.length>=2){
    tempPolyline=new fabric.Polyline(sectionPoints,{stroke:'#1d4ed8',fill:'rgba(99,102,241,.06)',strokeWidth:2,selectable:false,evented:false,objectCaching:false});
    tempPolyline._secTemp=true; canvas.add(tempPolyline);
  }
  sectionPoints.forEach(pt=>{ const dot=new fabric.Rect({left:pt.x-3,top:pt.y-3,width:6,height:6,fill:'#1d4ed8',selectable:false,evented:false,objectCaching:false}); dot._secTemp=true; tempMarkers.push(dot); canvas.add(dot); });
  canvas.requestRenderAll();
}
function drawSectionPreview(opt){
  if(!sectionPoints.length) return;
  const p=canvas.getPointer(opt.e);
  if(tempPreview){ canvas.remove(tempPreview); tempPreview=null; }
  const last=sectionPoints[sectionPoints.length-1];
  tempPreview=new fabric.Line([last.x,last.y,p.x,p.y],{stroke:'#1d4ed8',strokeWidth:1.5,strokeDashArray:[6,6],selectable:false,evented:false,objectCaching:false});
  tempPreview._secTemp=true; canvas.add(tempPreview);
  const hint=document.getElementById('pt-hint'); hint.style.display='block'; hint.style.left=p.x+'px'; hint.style.top=p.y+'px';
  canvas.requestRenderAll();
}
async function finishSection(){
  if(!drawingSection||sectionPoints.length<3){ cancelSectionDrawing(); return; }
  const nextOrder=1+canvas.getObjects().filter(o=>o.kind==='section').reduce((m,o)=>Math.max(m,o.section_order||0),0);
  const {value:form}=await Swal.fire({
    title:'Nueva secci√≥n',
    html:`<div style="text-align:left">
      <label>Nombre</label><input id="s-name" class="swal2-input" value="Secci√≥n ${nextOrder}">
      <label>Categor√≠a (texto)</label><input id="s-cat" class="swal2-input" placeholder="vip, general, etc.">
      <label>Orden</label><input id="s-order" class="swal2-input" type="number" value="${nextOrder}">
    </div>`,
    focusConfirm:false, showCancelButton:true,
    preConfirm:()=>{ const name=document.getElementById('s-name').value.trim(); const cat=document.getElementById('s-cat').value.trim(); const order=parseInt(document.getElementById('s-order').value||nextOrder,10); if(!name){ Swal.showValidationMessage('Nombre requerido'); return false; } return {name,cat,order}; }
  });
  if(!form){ cancelSectionDrawing(); return; }

  const poly=new fabric.Polygon(sectionPoints.map(p=>({x:p.x,y:p.y})),{
    fill:'rgba(100,100,100,.10)', stroke:'#475569', strokeWidth:3,
    objectCaching:false, noScaleCache:true, perPixelTargetFind:true, selectable:true
  });
  poly.kind='section';
  poly.section_name=form.name;
  poly.section_key=form.name.toLowerCase().replace(/\s+/g,'-')+'-'+Math.floor(Math.random()*1000);
  poly.section_order=form.order;
  poly.category=form.cat||'';
  poly.section_db_id=null;

  canvas.add(poly);
  poly.on('mousedblclick',()=>enterSectionEdit(poly));
  cancelSectionDrawing(); pushHistory(); refreshSectionSelector(); updateInfoPanel();
  document.getElementById('current-section').value=poly.section_key;
}
window.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&drawingSection){ e.preventDefault(); finishSection(); }
  if(e.key==='Escape'&&drawingSection){ e.preventDefault(); cancelSectionDrawing(); }
  if(sectionEditing){
    if(e.key==='Enter'){ e.preventDefault(); exitSectionEdit(true); }
    if(e.key==='Escape'){ e.preventDefault(); exitSectionEdit(false); }
    if((e.key==='Backspace'||e.key==='Delete') && selectedHandle && selectedHandle._type==='v'){
      const poly=sectionEditing;
      if(poly.points.length>3){ poly.points.splice(selectedHandle._index,1); refreshEditHandles(poly); }
    }
  }
});

/* Editar v√©rtices */
function worldToLocalOn(poly, wx, wy){ const inv=fabric.util.invertTransform(poly.calcTransformMatrix()); const p=fabric.util.transformPoint(new fabric.Point(wx,wy), inv); return { x:p.x + poly.pathOffset.x, y:p.y + poly.pathOffset.y }; }
function localToWorldOn(poly, lx, ly){ const m=poly.calcTransformMatrix(); const p=fabric.util.transformPoint(new fabric.Point(lx - poly.pathOffset.x, ly - poly.pathOffset.y), m); return { x:p.x, y:p.y }; }
function enterSectionEdit(poly){ if(sectionEditing) exitSectionEdit(false); sectionEditing=poly; poly.editing=true; poly.selectable=false; poly.noScaleCache=true; poly.objectCaching=false; poly.strokeUniform=true; editBackup=poly.points.map(p=>({x:p.x,y:p.y})); refreshEditHandles(poly); Toast.fire({icon:'info',title:'Editando v√©rtices (Enter confirma, Esc cancela)'}); }
function exitSectionEdit(commit){ const poly=sectionEditing; if(!poly) return; if(!commit){ poly.points=editBackup.map(p=>({x:p.x,y:p.y})); } editHandles.forEach(h=>canvas.remove(h)); editHandles=[]; midHandles.forEach(h=>canvas.remove(h)); midHandles=[]; selectedHandle=null; editBackup=[]; poly.selectable=true; poly.editing=false; poly.dirty=true; poly._setPositionDimensions({}); poly.setCoords(); sectionEditing=null; pushHistory(); canvas.requestRenderAll(); }
function refreshEditHandles(poly){
  editHandles.forEach(h=>canvas.remove(h)); editHandles=[]; midHandles.forEach(h=>canvas.remove(h)); midHandles=[]; selectedHandle=null;
  poly.points.forEach((pt,idx)=>{ const w=localToWorldOn(poly, pt.x, pt.y);
    const h=new fabric.Circle({left:w.x-5, top:w.y-5, radius:5, fill:'#2563eb', stroke:'#fff', strokeWidth:1, hasControls:false, hasBorders:false, selectable:true, hoverCursor:'pointer'});
    h._type='v'; h._index=idx;
    h.on('mousedown',()=>{ selectedHandle=h; });
    h.on('moving',()=>{ const lc=worldToLocalOn(poly, h.left+h.radius, h.top+h.radius); poly.points[h._index].x=lc.x; poly.points[h._index].y=lc.y; poly.dirty=true; poly._setPositionDimensions({}); poly.setCoords(); positionHandles(poly); canvas.requestRenderAll(); });
    canvas.add(h); editHandles.push(h);
  });
  for(let i=0;i<poly.points.length;i++){
    const j=(i+1)%poly.points.length;
    const a=localToWorldOn(poly, poly.points[i].x, poly.points[i].y);
    const b=localToWorldOn(poly, poly.points[j].x, poly.points[j].y);
    const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
    const m=new fabric.Circle({left:mx-4, top:my-4, radius:4, fill:'#ffffff', stroke:'#2563eb', strokeWidth:1, hasControls:false, hasBorders:false, selectable:true, hoverCursor:'copy'});
    m._type='m'; m._before=i;
    m.on('mousedown',()=>{ const loc=worldToLocalOn(poly, mx, my); poly.points.splice(m._before+1, 0, {x:loc.x, y:loc.y}); poly.dirty=true; poly._setPositionDimensions({}); poly.setCoords(); refreshEditHandles(poly); canvas.requestRenderAll(); });
    canvas.add(m); midHandles.push(m);
  }
}
function positionHandles(poly){
  editHandles.forEach(h=>{ const pt=poly.points[h._index]; const w=localToWorldOn(poly, pt.x, pt.y); h.set({left:w.x-5, top:w.y-5}); h.setCoords(); });
  midHandles.forEach(m=>{ const i=m._before, j=(i+1)%poly.points.length; const a=localToWorldOn(poly, poly.points[i].x, poly.points[i].y); const b=localToWorldOn(poly, poly.points[j].x, poly.points[j].y); const mx=(a.x+b.x)/2, my=(a.y+b.y)/2; m.set({left:mx-4, top:my-4}); m.setCoords(); });
}

/* Panel/leyenda (resumido) */
function updateInfoPanel(){
  const p=document.getElementById('info-panel'); p.innerHTML='';
  const sh=document.createElement('h3'); sh.textContent='Secciones'; p.appendChild(sh);
  canvas.getObjects().filter(o=>o.kind==='section').sort((a,b)=>(a.section_order||0)-(b.section_order||0))
    .forEach(sec=>{
      const pill=document.createElement('div'); pill.className='pill';
      const dot=document.createElement('div'); dot.className='dot'; dot.style.background=guessColorByKey(sec.category)||'#cbd5e1';
      const name=document.createElement('span'); name.textContent=sec.section_name + (sec.category?` ¬∑ ${sec.category}`:'');
      const orderInp=document.createElement('input'); orderInp.type='number'; orderInp.value=sec.section_order||0; orderInp.style.width='70px';
      orderInp.onchange=()=>{ sec.section_order=parseInt(orderInp.value||0,10); pushHistory(); refreshSectionSelector(); updateInfoPanel(); };
      pill.onclick=()=>{ canvas.setActiveObject(sec); document.getElementById('current-section').value=sec.section_key; canvas.requestRenderAll(); };
      pill.appendChild(dot); pill.appendChild(name); pill.appendChild(orderInp); p.appendChild(pill);
    });
}
const legendDiv=document.getElementById('legend');
function renderLegend(items){
  legendDiv.innerHTML='';
  (items||[]).forEach(it=>{
    const d=document.createElement('div'); d.className='item';
    const s=document.createElement('div'); s.className='swatch'; s.style.background=it.color||'#999';
    const t=document.createElement('span'); t.textContent=it.label||it.key||'';
    const del=document.createElement('button'); del.textContent='√ó';
    del.onclick=()=>{ legend=legend.filter(x=>x.key!==it.key); renderLegend(legend); pushHistory(); updateInfoPanel(); };
    d.appendChild(s); d.appendChild(t); d.appendChild(del); legendDiv.appendChild(d);
  });
  const add=document.createElement('button'); add.textContent='+ categor√≠a';
  add.onclick=async()=>{
    const {value:key}=await Swal.fire({title:'Clave',input:'text',showCancelButton:true});
    if(!key) return;
    if(legend.some(c=>c.key.toLowerCase()===key.toLowerCase())){ await Swal.fire({icon:'warning',title:'La categor√≠a ya existe'}); return; }
    const {value:label}=await Swal.fire({title:'Etiqueta visible',input:'text',inputValue:key,showCancelButton:true}); if(label===undefined) return;
    const {value:color}=await Swal.fire({title:'Color',html:'<input type="color" id="cat-color" value="#63b46b" style="width:100%;height:2.5em;">',focusConfirm:false,showCancelButton:true,preConfirm:()=>document.getElementById('cat-color')?.value}); if(!color) return;
    legend.push({key,label,color}); renderLegend(legend); pushHistory(); updateInfoPanel();
  };
  legendDiv.appendChild(add);
}

/* Fit / Historial / Serializaci√≥n / Reconciliar con BD */
function fitToContent(pad=40){
  const objs=canvas.getObjects().filter(o=>!o._secTemp);
  if(!objs.length){ canvas.setViewportTransform([1,0,0,1,0,0]); canvas.requestRenderAll(); return; }
  const g=new fabric.Group(objs); const b=g.getBoundingRect(); g.destroy();
  const vw=canvas.getWidth(), vh=canvas.getHeight();
  const sc=Math.min((vw-pad*2)/b.width,(vh-pad*2)/b.height,4);
  const v=[sc,0,0,sc,(vw-b.width*sc)/2-b.left*sc,(vh-b.height*sc)/2-b.top*sc];
  canvas.setViewportTransform(v); canvas.requestRenderAll();
}
const history={past:[],future:[],max:90,dirty:false};
function snapshot(){ return JSON.stringify(canvas.toJSON(['kind','number','category','id','seat_type','section_key','section_name','section_order','row_name','row_index','section_db_id'])); }
function pushHistory(){ const s=snapshot(); if(history.past.length && history.past.at(-1)===s) return; history.past.push(s); if(history.past.length>history.max) history.past.shift(); history.future=[]; history.dirty=true; }
function loadFromJSON(json,cb){ canvas.loadFromJSON(json,()=>{ canvas.getObjects().forEach(o=>{ if(o.kind==='section') o.on('mousedblclick',()=>enterSectionEdit(o)); if(o.kind==='seat') o.on('mousedblclick',async()=>{ await editSeatDialog(o); }); }); resizeCanvas(); canvas.renderAll(); cb&&cb(); }); }
function undo(){ if(!history.past.length) return; const cur=snapshot(); history.future.push(cur); const prev=history.past.pop(); if(!prev) return; loadFromJSON(prev,()=>{ updateInfoPanel(); refreshSectionSelector(); }); }
function redo(){ if(!history.future.length) return; const nxt=history.future.pop(); history.past.push(snapshot()); loadFromJSON(nxt,()=>{ updateInfoPanel(); refreshSectionSelector(); }); }
function primeHistory(){ history.past=[snapshot()]; history.future=[]; history.dirty=false; }
function buildSectionsModel(){
  const sections=[]; const secObjs=canvas.getObjects().filter(o=>o.kind==='section'); const allSeats=canvas.getObjects().filter(o=>o.kind==='seat');
  const tolY=Math.max(6, seatRadius*1.5);
  function center(s){ const c=s.getCenterPoint(); return {x:c.x,y:c.y}; }
  function clusterRows(seats){
    const sorted=seats.slice().sort((a,b)=>center(a).y-center(b).y); const groups=[];
    for(const s of sorted){ const cy=center(s).y; let ok=false; for(const g of groups){ const avg=g._avgY/g._n; if(Math.abs(cy-avg)<=tolY){ g.arr.push(s); g._avgY+=cy; g._n++; ok=true; break; } } if(!ok) groups.push({arr:[s],_avgY:cy,_n:1}); }
    groups.forEach(g=>g.arr.sort((a,b)=>center(a).x-center(b).x));
    return groups.map(g=>g.arr);
  }
  function letterName(i){return nextLetter(i);}
  for(const sec of secObjs){
    const polygon=sec.points.map(pt=>{ const w=localToWorldOn(sec,pt.x,pt.y); return {x:w.x,y:w.y}; });
    const seatsIn=allSeats.filter(s=>s.section_key===sec.section_key);
    let rowsMap={}; const named=seatsIn.filter(s=>s.row_name).length>0;
    if(named){ for(const s of seatsIn){ (rowsMap[s.row_name||'__cluster__'] ||= []).push(s); } }
    else{ const clusters=clusterRows(seatsIn); clusters.forEach((arr,idx)=>{ rowsMap[letterName(idx)]=arr; }); }
    let rows=Object.keys(rowsMap).map(name=>{ const arr=rowsMap[name]; arr.sort((a,b)=>center(a).x-center(b).x); const seats=arr.map((s,i)=>{ const c=center(s); return { number: String((s.number&&s.number.trim())?s.number:(i+1)), category:s.category||'', seat_type:s.seat_type||'standard', x:c.x, y:c.y }; }); const cyAvg=seats.reduce((a,v)=>a+v.y,0)/Math.max(1,seats.length); return {name,center_y:cyAvg,seats}; });
    rows.sort((a,b)=>a.center_y-b.center_y); rows.forEach((r,i)=>{ r.order=i+1; });
    sections.push({ id: sec.section_db_id || null, key: sec.section_key, name: sec.section_name, category: sec.category||'', order: sec.section_order||0, polygon, rows: rows.map(r=>({name:r.name, order:r.order, seats:r.seats})) });
  }
  return sections;
}
function serialize(){
  return {
    version: 6,
    engine: 'fabric',
    legend,
    ui: { gapX, gapY, seatRadius },
    canvas: { width: canvas.getWidth(), height: canvas.getHeight() },
    fabric: canvas.toJSON(['kind','number','category','id','seat_type','section_key','section_name','section_order','row_name','row_index','section_db_id']),
    sections: buildSectionsModel()
  };
}
function reconcileWithDb(dbSections){
  if(!Array.isArray(dbSections)) return;
  const polys = canvas.getObjects().filter(o=>o.kind==='section'); if(!polys.length) return;
  const byId = Object.fromEntries(dbSections.map(s=>[String(s.id), s]));
  polys.forEach(p => { if(p.section_db_id && byId[String(p.section_db_id)]) { const s = byId[String(p.section_db_id)]; p.section_name=s.name; p.category=s.category||p.category; if(s.order!=null) p.section_order=s.order; }});
  const noId = polys.filter(p=>!p.section_db_id);
  if(noId.length){
    const sortedPolys = polys.slice().sort((a,b)=>(a.section_order||0)-(b.section_order||0) || norm(a.section_name).localeCompare(norm(b.section_name)));
    const sortedDb = dbSections.slice().sort((a,b)=>((a.order||0)-(b.order||0)) || norm(a.name).localeCompare(norm(b.name)));
    if(sortedPolys.length === sortedDb.length){
      sortedPolys.forEach((p,i)=>{ if(!p.section_db_id){ const s = sortedDb[i]; p.section_db_id = String(s.id); p.section_name = s.name; if(s.order!=null) p.section_order=s.order; p.category=s.category||p.category; } });
    } else if(polys.length===1 && dbSections.length===1){
      const p=polys[0], s=dbSections[0]; p.section_db_id=String(s.id); p.section_name=s.name; if(s.order!=null) p.section_order=s.order; p.category=s.category||p.category;
    } else {
      noId.forEach(p=>{ const match = dbSections.find(s=>norm(s.name)===norm(p.section_name)); if(match){ p.section_db_id=String(match.id); p.section_name=match.name; if(match.order!=null) p.section_order=match.order; p.category=match.category||p.category; } });
    }
  }
  canvas.requestRenderAll(); refreshSectionSelector(); updateInfoPanel();
}

/* Portapapeles + atajos */
function getActiveObjects(){ const a=canvas.getActiveObjects(); return a&&a.length?a:[]; }
function copySelected(){ const o=getActiveObjects(); if(!o.length) return; clipboard=o.slice(); Toast.fire({icon:'info',title:'Copiado'}); }
function pasteClipboard(){ if(!clipboard||!clipboard.length) return; const clones=[]; let n=0;
  clipboard.forEach(orig=>{ orig.clone(cl=>{ cl.kind=orig.kind; cl.number=orig.number; cl.category=orig.category; cl.seat_type=orig.seat_type; cl.section_key=orig.section_key; cl.section_name=orig.section_name; cl.section_order=orig.section_order; cl.row_name=orig.row_name; cl.row_index=orig.row_index; cl.section_db_id=orig.section_db_id||null;
    if(orig.kind==='seat'){ cl.set({fill:orig.fill}); cl.id='seat-'+seatIdCounter++; }
    cl.set({left:(orig.left||0)+12, top:(orig.top||0)+12, evented:true});
    clones.push(cl); n++; if(n===clipboard.length){ clones.forEach(c=>canvas.add(c)); canvas.setActiveObject(clones[0]); pushHistory(); canvas.requestRenderAll(); updateInfoPanel(); refreshSectionSelector(); }
  });});
}
function cutSelected(){ const o=getActiveObjects(); if(!o.length) return; copySelected(); o.forEach(x=>canvas.remove(x)); pushHistory(); canvas.requestRenderAll(); updateInfoPanel(); refreshSectionSelector(); }
document.addEventListener('keydown',e=>{ const mod=e.ctrlKey||e.metaKey; if(mod&&e.key.toLowerCase()==='s'){ e.preventDefault(); doSave(); } if(mod&&e.key.toLowerCase()==='z'&&!e.shiftKey){ e.preventDefault(); undo(); updateInfoPanel(); refreshSectionSelector(); } if((mod&&e.key.toLowerCase()==='y')||(mod&&e.key.toLowerCase()==='z'&&e.shiftKey)){ e.preventDefault(); redo(); updateInfoPanel(); refreshSectionSelector(); } if(mod&&e.key.toLowerCase()==='c') copySelected(); if(mod&&e.key.toLowerCase()==='v') pasteClipboard(); if(mod&&e.key.toLowerCase()==='x') cutSelected(); });

/* Fit / Guardado */
document.getElementById('btn-fit').onclick=()=>fitToContent();
document.getElementById('btn-save').onclick=()=>doSave();
document.getElementById('btn-undo').onclick=()=>{ undo(); updateInfoPanel(); refreshSectionSelector(); };
document.getElementById('btn-redo').onclick=()=>{ redo(); updateInfoPanel(); refreshSectionSelector(); };
document.getElementById('btn-delete').onclick=()=>{ const o=canvas.getActiveObjects(); if(!o.length) return; canvas.discardActiveObject(); o.forEach(x=>canvas.remove(x)); pushHistory(); canvas.requestRenderAll(); updateInfoPanel(); refreshSectionSelector(); };

async function loadData(){
  try{
    const r=await fetch(LOAD_URL,{headers:{'X-Requested-With':'XMLHttpRequest'}});
    const j=await r.json();
    if(!j.ok){ Swal.fire({icon:'error',title:'No se pudo cargar',text:j.error||''}); return; }
    const data=j.data||{};
    legend=data.legend||data.Legend||[]; renderLegend(legend);
    if(data.ui){ if(typeof data.ui.gapX==='number') gapX=data.ui.gapX; if(typeof data.ui.gapY==='number') gapY=data.ui.gapY; if(typeof data.ui.seatRadius==='number') seatRadius=data.ui.seatRadius; document.getElementById('gap-x').value=gapX; document.getElementById('gap-y').value=gapY; document.getElementById('seat-radius').value=seatRadius; }

    const afterLoad=()=>{ primeHistory(); fitToContent(); updateInfoPanel(); refreshSectionSelector(); reconcileWithDb(j.db_sections||[]); if(window.__seatsio_layout) window.__seatsio_layout(); };

    if(data.engine==='fabric' && data.fabric){ loadFromJSON(data.fabric,afterLoad); }
    else if(Array.isArray(data.sections) && data.sections.length){
      // reconstrucci√≥n m√≠nima desde sections
      for(const sec of data.sections){
        const poly=new fabric.Polygon((sec.polygon||[]).map(p=>({x:p.x,y:p.y})),{ fill:'rgba(100,100,100,.10)', stroke:'#475569', strokeWidth:3, objectCaching:false, noScaleCache:true, perPixelTargetFind:true, selectable:true });
        poly.kind='section'; poly.section_name=sec.name; poly.section_key=sec.key||(sec.name.toLowerCase().replace(/\s+/g,'-')+'-'+Math.floor(Math.random()*1000)); poly.section_order=sec.order||0; poly.category=sec.category||''; poly.section_db_id=sec.id?String(sec.id):null;
        canvas.add(poly); poly.on('mousedblclick',()=>enterSectionEdit(poly));
        for(const row of (sec.rows||[])){ let i=0; for(const s of (row.seats||[])){ const c=seatCircle(s.x,s.y,poly,{number:(s.number||String(++i)), row_name:row.name}); canvas.add(c); } }
      }
      afterLoad();
    }else{
      loadFromJSON({version:'5.3.0',objects:[]},()=>{ primeHistory(); if(window.__seatsio_layout) window.__seatsio_layout(); });
    }
  }catch(err){ Swal.fire({icon:'error',title:'Error de red',text:String(err)}); }
}
async function doSave(){
  const payload={data:serialize()};
  try{
    const r=await fetch(SAVE_URL,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':CSRF_TOKEN,'X-Requested-With':'XMLHttpRequest'},body:JSON.stringify(payload)});
    const j=await r.json();
    if(j.ok){ history.dirty=false; Toast.fire({icon:'success',title:'Guardado'}); }
    else Swal.fire({icon:'error',title:'Error al guardar',text:j.error?String(j.error):JSON.stringify(j)});
  }catch(err){ Swal.fire({icon:'error',title:'Error de red',text:String(err)}); }
}
window.addEventListener('beforeunload',e=>{ if(history.dirty){ e.preventDefault(); e.returnValue=''; }});

/* Init */
setMode('section');   // puedes cambiar a 'select' si prefieres
loadData();
</script>
{% endblock %}
